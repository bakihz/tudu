<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Stok Raporu Excel Tablosu</title>
    <link rel="stylesheet" href="../src/styles/Reports/StockReport.css" />
  </head>
  <body>
    <div class="container">
      <h2>Stok Raporu Excel Tablosu</h2>
      
      <div id="loading">ðŸ”„ Veriler yÃ¼kleniyor...</div>
      <div id="error-message"></div>
      
      <label>SQL Sorgunuz:</label>
      <textarea id="sql-query" readonly>
SELECT * FROM
(
SELECT ITM.CODE AS KOD, ITM.NAME AS AÃ‡IKLAMA, ITM.STGRPCODE AS GRUP,ITM.CYPHCODE AS [Y.KODU],ITM.SPECODE AS [Ã–.KOD],ITM.SPECODE2 AS [Ã–.KOD-2],ITM.SPECODE3 AS [Ã–.KOD-3], ITM.SPECODE4 AS [Ã–.KOD-4], ITM.SPECODE5 AS [Ã–.KOD-5],
(SELECT DESCR FROM LG_010_MARK WHERE LOGICALREF=ITM.MARKREF) AS [MARKA],
A.YEAR_ AS YIL, A.AY,A.MONTH_, 
(SELECT CODE FROM LG_010_UNITSETL WHERE UNITSETREF=ITM.UNITSETREF AND MAINUNIT=1) AS "A.BÄ°RÄ°M" 
,A.SATIS, A.ALIM 
,(SELECT ROUND(ONHAND,2) FROM LV_010_01_GNTOTST WHERE STOCKREF=ITM.LOGICALREF AND INVENNO=-1) AS "FÄ°Ä°LÄ° STOK"
,(SELECT ROUND(ACTSORDER,2) FROM LV_010_01_GNTOTST WHERE STOCKREF=ITM.LOGICALREF AND INVENNO=-1) AS "BEKLEYEN SÄ°P."
,(SELECT TOP(1) PRICE FROM LG_010_PRCLIST WHERE CARDREF=ITM.LOGICALREF AND ACTIVE=0 AND PTYPE=1) AS "ALIÅž FÄ°Y."
,(SELECT TOP(1) PRICE FROM LG_010_PRCLIST WHERE CARDREF=ITM.LOGICALREF AND ACTIVE=0 AND PTYPE=2) AS "SATIÅž FÄ°Y."

FROM LG_010_ITEMS ITM , 
(SELECT [STOCKREF]
      ,MONTH_
      ,CASE MONTH_ 
WHEN 1 THEN '01-Ocak'
when 2 then '02-Åžubat'
when 3 then '03-Mart'
when 4 then '04-Nisan'
when 5 then '05-MayÄ±s'
when 6 then '06-Haziran'
when 7 then '07-Temmuz'
when 8 then '08-AÄŸustos'
when 9 then '09-EylÃ¼l'
when 10 then '10-Ekim'
when 11 then '11-KasÄ±m'
when 12 then '12-AralÄ±k' end AS AY
      ,SUM([SALES_AMOUNT]) AS SATIS
      ,SUM([SALES_RETAMNT]) AS SIADE
      ,SUM([PURCHASES_AMOUNT]) AS ALIM
      ,SUM([PURCHASES_RETAMNT]) AS AIADE
      ,[YEAR_]  
 FROM [LV_010_01_STINVENS] WHERE MTRLINC<>1 AND INVENNO=-1 
 GROUP BY STOCKREF, YEAR_,MONTH_ ) AS A
 WHERE A.STOCKREF=ITM.LOGICALREF
) AS DYNMQRY
WHERE
(DYNMQRY.MONTH_ IN (1,2,3,4,5,6,7,8,9,10,11,12))
AND (DYNMQRY.[YIL] = 2025)
ORDER BY DYNMQRY.[KOD] ASC, DYNMQRY.[AÃ‡IKLAMA] ASC, DYNMQRY.[GRUP] ASC, DYNMQRY.[Ã–.KOD] ASC, DYNMQRY.[Ã–.KOD-2] ASC, DYNMQRY.[Ã–.KOD-3] ASC
      </textarea>

      <div class="btn-group">
        <button class="btn btn-success" onclick="fetchStockReport()">
          ðŸ“Š Database'den Veri Ã‡ek
        </button>
      </div>

      <label>SQL Sonucu (CSV olarak yapÄ±ÅŸtÄ±rÄ±n):</label>
      <textarea
        id="csv-input"
        placeholder="Buraya SQL Ã§Ä±ktÄ±sÄ±nÄ± CSV olarak yapÄ±ÅŸtÄ±rÄ±n veya yukarÄ±daki butonu kullanarak database'den otomatik Ã§ekin..."
      ></textarea>
      
      <div class="btn-group">
        <button class="btn" onclick="csvToTable()">Tabloya DÃ¶nÃ¼ÅŸtÃ¼r</button>
        <button class="btn" onclick="exportTableToExcel()">Excel'e Aktar</button>
      </div>

    <div id="table-container" style="margin-top: 24px"></div>

    <script>
      // Database'den stok raporu verisini Ã§ek
      async function fetchStockReport() {
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        
        try {
          // Loading gÃ¶ster
          if (loadingDiv) loadingDiv.style.display = 'block';
          if (errorDiv) errorDiv.style.display = 'none';

          const response = await fetch('/api/stock-report', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              year: 2025,
              months: [1,2,3,4,5,6,7,8,9,10,11,12]
            })
          });

          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Veri Ã§ekilirken hata oluÅŸtu');
          }

          if (result.success) {
            // Veriyi tabloya dÃ¶nÃ¼ÅŸtÃ¼r
            displayDataAsTable(result.data, result.columns);
            
            // CSV input alanÄ±nÄ± da doldur (isteÄŸe baÄŸlÄ±)
            const csvData = convertToCSV(result.data, result.columns);
            document.getElementById('csv-input').value = csvData;
            
            console.log(`${result.count} kayÄ±t baÅŸarÄ±yla yÃ¼klendi.`);
          } else {
            throw new Error(result.message || 'Beklenmeyen hata');
          }
          
        } catch (error) {
          console.error('Stok raporu yÃ¼klenirken hata:', error);
          if (errorDiv) {
            errorDiv.textContent = `Hata: ${error.message}`;
            errorDiv.style.display = 'block';
          } else {
            alert('Stok raporu yÃ¼klenirken hata oluÅŸtu: ' + error.message);
          }
        } finally {
          // Loading gizle
          if (loadingDiv) loadingDiv.style.display = 'none';
        }
      }

      // Veriyi tablo olarak gÃ¶ster
      function displayDataAsTable(data, columns) {
        if (!data || data.length === 0) {
          document.getElementById('table-container').innerHTML = '<p>Veri bulunamadÄ±.</p>';
          return;
        }

        let html = '<table><thead><tr>';
        columns.forEach(col => {
          html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.forEach(row => {
          html += '<tr>';
          columns.forEach(col => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            html += `<td contenteditable="true">${value}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById('table-container').innerHTML = html;
      }

      // JSON verisini CSV formatÄ±na Ã§evir
      function convertToCSV(data, columns) {
        if (!data || data.length === 0) return '';
        
        let csv = columns.map(col => `"${col}"`).join(';') + '\n';
        
        data.forEach(row => {
          const values = columns.map(col => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            return `"${String(value).replace(/"/g, '""')}"`;
          });
          csv += values.join(';') + '\n';
        });
        
        return csv;
      }

      function csvToTable() {
        const csv = document.getElementById("csv-input").value.trim();
        if (!csv) return;
        const rows = csv
          .split("\n")
          .map((row) =>
            row.split(";").map((cell) => cell.replace(/^"|"$/g, ""))
          );
        let html = "<table><thead><tr>";
        rows[0].forEach((h) => (html += `<th>${h}</th>`));
        html += "</tr></thead><tbody>";
        for (let i = 1; i < rows.length; i++) {
          html += "<tr>";
          rows[i].forEach(
            (cell) => (html += `<td contenteditable="true">${cell}</td>`)
          );
          html += "</tr>";
        }
        html += "</tbody></table>";
        document.getElementById("table-container").innerHTML = html;
      }

      function exportTableToExcel() {
        const table = document.querySelector("#table-container table");
        if (!table) return;
        let csv = "";
        for (let row of table.rows) {
          let rowData = [];
          for (let cell of row.cells) {
            let text = cell.innerText.replace(/"/g, '""');
            rowData.push('"' + text + '"');
          }
          csv += rowData.join(";") + "\n";
        }
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "stok-raporu.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    </script>

  </body>
</html>
