<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Stok Raporu Excel Tablosu</title>
    <link rel="stylesheet" href="../src/styles/Reports/StockReport.css" />
  </head>
  <body>
    <div class="container">
      <!-- Go Back Navigation -->
      <div class="navigation-header">
        <button class="btn btn-back" onclick="goBack()">
          ‚Üê Geri D√∂n
        </button>
        <button class="btn btn-home" onclick="goHome()">
          üè† Ana Men√º
        </button>
      </div>
      
      <h2>Stok Raporu Excel Tablosu</h2>
      
      <div id="loading">üîÑ Veriler y√ºkleniyor...</div>
      <div id="error-message"></div>
      
      <label>SQL Sorgunuz:</label>
      <textarea id="sql-query" readonly>
SELECT * FROM
(
SELECT ITM.CODE AS KOD, ITM.NAME AS A√áIKLAMA, ITM.STGRPCODE AS GRUP,ITM.CYPHCODE AS [Y.KODU],ITM.SPECODE AS [√ñ.KOD],ITM.SPECODE2 AS [√ñ.KOD-2],ITM.SPECODE3 AS [√ñ.KOD-3], ITM.SPECODE4 AS [√ñ.KOD-4], ITM.SPECODE5 AS [√ñ.KOD-5],
(SELECT DESCR FROM LG_010_MARK WHERE LOGICALREF=ITM.MARKREF) AS [MARKA],
A.YEAR_ AS YIL, A.AY,A.MONTH_, 
(SELECT CODE FROM LG_010_UNITSETL WHERE UNITSETREF=ITM.UNITSETREF AND MAINUNIT=1) AS "A.Bƒ∞Rƒ∞M" 
,A.SATIS, A.ALIM 
,(SELECT ROUND(ONHAND,2) FROM LV_010_01_GNTOTST WHERE STOCKREF=ITM.LOGICALREF AND INVENNO=-1) AS "Fƒ∞ƒ∞Lƒ∞ STOK"
,(SELECT ROUND(ACTSORDER,2) FROM LV_010_01_GNTOTST WHERE STOCKREF=ITM.LOGICALREF AND INVENNO=-1) AS "BEKLEYEN Sƒ∞P."
,(SELECT TOP(1) PRICE FROM LG_010_PRCLIST WHERE CARDREF=ITM.LOGICALREF AND ACTIVE=0 AND PTYPE=1) AS "ALI≈û Fƒ∞Y."
,(SELECT TOP(1) PRICE FROM LG_010_PRCLIST WHERE CARDREF=ITM.LOGICALREF AND ACTIVE=0 AND PTYPE=2) AS "SATI≈û Fƒ∞Y."

FROM LG_010_ITEMS ITM , 
(SELECT [STOCKREF]
      ,MONTH_
      ,CASE MONTH_ 
WHEN 1 THEN '01-Ocak'
when 2 then '02-≈ûubat'
when 3 then '03-Mart'
when 4 then '04-Nisan'
when 5 then '05-Mayƒ±s'
when 6 then '06-Haziran'
when 7 then '07-Temmuz'
when 8 then '08-Aƒüustos'
when 9 then '09-Eyl√ºl'
when 10 then '10-Ekim'
when 11 then '11-Kasƒ±m'
when 12 then '12-Aralƒ±k' end AS AY
      ,SUM([SALES_AMOUNT]) AS SATIS
      ,SUM([SALES_RETAMNT]) AS SIADE
      ,SUM([PURCHASES_AMOUNT]) AS ALIM
      ,SUM([PURCHASES_RETAMNT]) AS AIADE
      ,[YEAR_]  
 FROM [LV_010_01_STINVENS] WHERE MTRLINC<>1 AND INVENNO=-1 
 GROUP BY STOCKREF, YEAR_,MONTH_ ) AS A
 WHERE A.STOCKREF=ITM.LOGICALREF
) AS DYNMQRY
WHERE
(DYNMQRY.MONTH_ IN (1,2,3,4,5,6,7,8,9,10,11,12))
AND (DYNMQRY.[YIL] = 2025)
ORDER BY DYNMQRY.[KOD] ASC, DYNMQRY.[A√áIKLAMA] ASC, DYNMQRY.[GRUP] ASC, DYNMQRY.[√ñ.KOD] ASC, DYNMQRY.[√ñ.KOD-2] ASC, DYNMQRY.[√ñ.KOD-3] ASC
      </textarea>

      <div class="btn-group">
        <button class="btn btn-success" onclick="fetchStockReport()">
          üìä Database'den Veri √áek
        </button>
      </div>

      <label>SQL Sonucu (CSV olarak yapƒ±≈ütƒ±rƒ±n):</label>
      <textarea
        id="csv-input"
        placeholder="Buraya SQL √ßƒ±ktƒ±sƒ±nƒ± CSV olarak yapƒ±≈ütƒ±rƒ±n veya yukarƒ±daki butonu kullanarak database'den otomatik √ßekin..."
      ></textarea>
      
      <div class="btn-group">
        <button class="btn" onclick="csvToTable()">Tabloya D√∂n√º≈üt√ºr</button>
        <button class="btn" onclick="exportTableToExcel()">Excel'e Aktar</button>
      </div>

    <div id="table-container" style="margin-top: 24px"></div>
    
    <!-- Version Info Footer -->
    <div class="version-footer">
      <span id="version-info">Tudu v1.0.9</span>
      <span class="version-date">¬© 2025 Bakihz</span>
    </div>

    <script>
      // Database'den stok raporu verisini √ßek
      async function fetchStockReport() {
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        
        try {
          // Loading g√∂ster
          if (loadingDiv) loadingDiv.style.display = 'block';
          if (errorDiv) errorDiv.style.display = 'none';

          const response = await fetch('/api/stock-report', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              year: 2025,
              months: [1,2,3,4,5,6,7,8,9,10,11,12]
            })
          });

          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Veri √ßekilirken hata olu≈ütu');
          }

          if (result.success) {
            // Veriyi tabloya d√∂n√º≈üt√ºr
            displayDataAsTable(result.data, result.columns);
            
            // CSV input alanƒ±nƒ± da doldur (isteƒüe baƒülƒ±)
            const csvData = convertToCSV(result.data, result.columns);
            document.getElementById('csv-input').value = csvData;
            
            console.log(`${result.count} kayƒ±t ba≈üarƒ±yla y√ºklendi.`);
          } else {
            throw new Error(result.message || 'Beklenmeyen hata');
          }
          
        } catch (error) {
          console.error('Stok raporu y√ºklenirken hata:', error);
          if (errorDiv) {
            errorDiv.textContent = `Hata: ${error.message}`;
            errorDiv.style.display = 'block';
          } else {
            alert('Stok raporu y√ºklenirken hata olu≈ütu: ' + error.message);
          }
        } finally {
          // Loading gizle
          if (loadingDiv) loadingDiv.style.display = 'none';
        }
      }

      // Veriyi tablo olarak g√∂ster
      function displayDataAsTable(data, columns) {
        if (!data || data.length === 0) {
          document.getElementById('table-container').innerHTML = '<p>Veri bulunamadƒ±.</p>';
          return;
        }

        let html = '<table><thead><tr>';
        columns.forEach(col => {
          html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.forEach(row => {
          html += '<tr>';
          columns.forEach(col => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            html += `<td contenteditable="true">${value}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById('table-container').innerHTML = html;
      }

      // JSON verisini CSV formatƒ±na √ßevir
      function convertToCSV(data, columns) {
        if (!data || data.length === 0) return '';
        
        let csv = columns.map(col => `"${col}"`).join(';') + '\n';
        
        data.forEach(row => {
          const values = columns.map(col => {
            const value = row[col] !== null && row[col] !== undefined ? row[col] : '';
            return `"${String(value).replace(/"/g, '""')}"`;
          });
          csv += values.join(';') + '\n';
        });
        
        return csv;
      }

      function csvToTable() {
        const csv = document.getElementById("csv-input").value.trim();
        if (!csv) return;
        const rows = csv
          .split("\n")
          .map((row) =>
            row.split(";").map((cell) => cell.replace(/^"|"$/g, ""))
          );
        let html = "<table><thead><tr>";
        rows[0].forEach((h) => (html += `<th>${h}</th>`));
        html += "</tr></thead><tbody>";
        for (let i = 1; i < rows.length; i++) {
          html += "<tr>";
          rows[i].forEach(
            (cell) => (html += `<td contenteditable="true">${cell}</td>`)
          );
          html += "</tr>";
        }
        html += "</tbody></table>";
        document.getElementById("table-container").innerHTML = html;
      }

      function exportTableToExcel() {
        const table = document.querySelector("#table-container table");
        if (!table) return;
        let csv = "";
        for (let row of table.rows) {
          let rowData = [];
          for (let cell of row.cells) {
            let text = cell.innerText.replace(/"/g, '""');
            rowData.push('"' + text + '"');
          }
          csv += rowData.join(";") + "\n";
        }
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "stok-raporu.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Navigation functions
      function goBack() {
        // Check if there's a previous page in history
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // If no history, go to tasks page (main menu)
          window.location.href = 'tasks.html';
        }
      }

      function goHome() {
        // Go to main tasks page
        window.location.href = 'tasks.html';
      }
    </script>

    <style>
      .navigation-header {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }

      .btn-back, .btn-home {
        padding: 8px 16px;
        border: 1px solid #007bff;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .btn-back:hover, .btn-home:hover {
        background-color: #0056b3;
        border-color: #0056b3;
      }

      .btn-home {
        background-color: #28a745;
        border-color: #28a745;
      }

      .btn-home:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
      }
      
      .version-footer {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 12px;
        color: #666;
        background: rgba(255, 255, 255, 0.9);
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
        z-index: 1000;
      }
      
      .version-footer span {
        display: block;
        text-align: right;
      }
      
      .version-date {
        font-size: 10px;
        color: #999;
        margin-top: 2px;
      }
    </style>

  </body>
</html>
